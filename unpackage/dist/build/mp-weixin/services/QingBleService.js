"use strict";const t=require("../common/vendor.js"),e=require("./define.js"),i=require("../utils/helper.js"),n=require("../utils/util.js"),s=require("./QingUUID.js"),r=require("./QingCommandType.js"),c=class c{constructor(t){this.timeout=2e4,this.scanTimer=null,this.targetDeviceOption=null,this.currentDevice=null,this.isConnected=!1,this.print=(...t)=>i.helper.log(c.LogTag,...t),this.commandMap=new Map,this.scanResolve=null,this.onConnectStatusChange=null,this.onBluetoothDeviceFound=({devices:t})=>{var e;if(0===t.length)return;const i=t.filter(this.filterBroadcast).map(this.parseBroadcastData).find((t=>{var e,i;return(null==(e=this.targetDeviceOption)?void 0:e.mac)?t.mac===this.targetDeviceOption.mac:t.productID===(null==(i=this.targetDeviceOption)?void 0:i.productId)&&!t.isBind}));i&&(this.print("找到目标设备:",i),this.stopScan(),null==(e=this.scanResolve)||e.call(this,i),this.scanTimer&&clearTimeout(this.scanTimer),this.scanResolve=null)},this.onBLECharacteristicValueChange=({characteristicId:t,deviceId:e,value:i})=>{var s;if(e!==(null==(s=this.currentDevice)?void 0:s.deviceId))return void this.print("onBLECharacteristicValueChange: deviceId 不匹配",e);this.print("onBLECharacteristicValueChange:",t,n.uint8Array2hexString(new Uint8Array(i)));const c=new Uint8Array(i);c[0];let a=c[1],o=c.slice(2);a===r.QingCommandType.CommandExecResult&&(o=c.slice(3));const h=`${t}_${a===r.QingCommandType.CommandExecResult?c[2]:a}`;if(!this.commandMap.has(h))return void this.print(`未找到对应的命令:${h}, 已经存命令:${Array.from(this.commandMap.keys())}`);const u=this.commandMap.get(h);if(a===r.QingCommandType.CommandExecResult)return 0===o[0]?u.resolve({success:!0,data:o}):u.resolve({success:!1,data:o}),clearTimeout(u.timeoutId),void this.commandMap.delete(h);if(u.isSplitReceive){const t=o[0],e=o[1],i=o.slice(2);if(u.receivedData=new Uint8Array([...u.receivedData,...i]),e<t)return void this.commandMap.set(h,u);u.resolve({success:!0,data:u.receivedData}),clearTimeout(u.timeoutId),this.commandMap.delete(h)}else u.resolve({success:!0,data:o}),clearTimeout(u.timeoutId),this.commandMap.delete(h)},this.onBLEConnectionStateChange=({deviceId:t,connected:i})=>{var n,s;this.print("onBLEConnectionStateChange:",t,i),t===(null==(n=this.currentDevice)?void 0:n.deviceId)&&(this.isConnected=i,i||(null==(s=this.onConnectStatusChange)||s.call(this,e.EConnectStep.Disconnected,e.EConnectStepStatus.Success,this.currentDevice),this.removeSubscriptions()))},this.onConnectStatusChange=t,this.setupSubscriptions()}async startConnect(i){var s,r,c,a,o,h,u,l;try{await t.index.setKeepScreenOn({keepScreenOn:!0}),this.targetDeviceOption=i;const l=await this.startScan();if("errCode"in l)throw null==(s=this.onConnectStatusChange)||s.call(this,e.EConnectStep.Scan,e.EConnectStepStatus.Failed,this.currentDevice),l;null==(r=this.onConnectStatusChange)||r.call(this,e.EConnectStep.Scan,e.EConnectStepStatus.Success,this.currentDevice),this.currentDevice=l;const{deviceId:C}=this.currentDevice;null==(c=this.onConnectStatusChange)||c.call(this,e.EConnectStep.Connect,e.EConnectStepStatus.InProgress,this.currentDevice),await t.index.createBLEConnection({deviceId:C,timeout:i.timeout||this.timeout}),this.isConnected=!0,null==(a=this.onConnectStatusChange)||a.call(this,e.EConnectStep.Connect,e.EConnectStepStatus.Success,this.currentDevice),await this.startServiceListen();const d=(null==(o=this.targetDeviceOption)?void 0:o.token)||n.generateToken();this.currentDevice.token=d;if(!(await this.setToken(d)))throw null==(h=this.onConnectStatusChange)||h.call(this,e.EConnectStep.SetToken,e.EConnectStepStatus.Failed,this.currentDevice),{errCode:e.EErrorCode.NotFound,errMessage:"设置 token 失败"};if(!(await this.setToken(d,"verify")))throw null==(u=this.onConnectStatusChange)||u.call(this,e.EConnectStep.VerifyToken,e.EConnectStepStatus.Failed,this.currentDevice),{errCode:e.EErrorCode.NotFound,errMessage:"验证 token 失败"};return this.currentDevice}catch(C){throw null==(l=this.onConnectStatusChange)||l.call(this,e.EConnectStep.Connect,e.EConnectStepStatus.Failed,this.currentDevice),this.print("连接失败",C),C}finally{t.index.setKeepScreenOn({keepScreenOn:!1}),this.scanTimer&&clearTimeout(this.scanTimer),this.scanTimer=null,this.scanResolve=null}}async getWifiList(){var t;try{null==(t=this.onConnectStatusChange)||t.call(this,e.EConnectStep.GetWifiList,e.EConnectStepStatus.InProgress,this.currentDevice);const i=await this.write({writeCharacteristicUUID:s.QingUUID.SPARROW_PRIVATE_WRITE_CHARACTERISTIC_UUID,notifyCharacteristicUUID:s.QingUUID.SPARROW_PRIVATE_NOTIFY_CHARACTERISTIC_UUID,type:r.QingCommandType.GetWifiList,isSplitReceive:!0,timeout:4e4});return"errCode"in i||!i.success?(this.print("获取 Wi-Fi 列表失败",i),[]):(this.print("获取 Wi-Fi 列表成功",i,n.formatBytes(i.data,"str")),n.parseWifiList(i.data))}catch(i){return this.print("获取 Wi-Fi 列表失败",i),[]}}async setWifi(t,i=""){var c,a,o;null==(c=this.onConnectStatusChange)||c.call(this,e.EConnectStep.SetWifi,e.EConnectStepStatus.InProgress,this.currentDevice);const h=`"${t}","${i}"`,u=n.strToBytes(h);try{const t=await this.write({writeCharacteristicUUID:s.QingUUID.SPARROW_PRIVATE_WRITE_CHARACTERISTIC_UUID,notifyCharacteristicUUID:s.QingUUID.SPARROW_PRIVATE_NOTIFY_CHARACTERISTIC_UUID,type:r.QingCommandType.SetWifi,data:new Uint8Array(u),timeout:6e4});return"errCode"in t||!t.success?(this.print("连接 Wi-Fi 失败",t),null==(a=this.onConnectStatusChange)||a.call(this,e.EConnectStep.SetWifi,e.EConnectStepStatus.Failed,this.currentDevice),!1):(this.print("连接 Wi-Fi 成功",t),null==(o=this.onConnectStatusChange)||o.call(this,e.EConnectStep.SetWifi,e.EConnectStepStatus.Success,this.currentDevice),!0)}catch(l){return this.print("连接 Wi-Fi 失败",l),!1}}async setMqtt(t){var i;this.print("mqtt:",t);const c=n.strToBytes(`${t.host.trim()} ${t.port} ${t.username.trim()} ${t.password.trim()}`),a=n.strToBytes(`${t.clientId.trim()} ${t.subTopic.trim()} ${t.pubTopic.trim()}`);null==(i=this.onConnectStatusChange)||i.call(this,e.EConnectStep.SetMqtt,e.EConnectStepStatus.InProgress,this.currentDevice);try{const t=await this.write({writeCharacteristicUUID:s.QingUUID.BASE_WRITE_CHARACTERISTIC_UUID,notifyCharacteristicUUID:s.QingUUID.BASE_NOTIFY_CHARACTERISTIC_UUID,type:r.QingCommandType.SetMqttPart1,data:new Uint8Array(c),timeout:3e4});if("errCode"in t||!t.success)return this.print("设置 MQTT Part1 设置失败",t),!1;const e=await this.write({writeCharacteristicUUID:s.QingUUID.BASE_WRITE_CHARACTERISTIC_UUID,notifyCharacteristicUUID:s.QingUUID.BASE_NOTIFY_CHARACTERISTIC_UUID,type:r.QingCommandType.SetMqttPart2,data:new Uint8Array(a),timeout:3e4});if("errCode"in e||!e.success)return this.print("设置 MQTT Part2 设置失败",e),!1}catch(o){return this.print("设置 MQTT 失败",o),!1}return!0}async setToken(t,i="set"){var n,c,a,o;try{null==(n=this.onConnectStatusChange)||n.call(this,"set"===i?e.EConnectStep.SetToken:e.EConnectStep.VerifyToken,e.EConnectStepStatus.InProgress,this.currentDevice);const o=await this.write({writeCharacteristicUUID:s.QingUUID.BASE_WRITE_CHARACTERISTIC_UUID,notifyCharacteristicUUID:s.QingUUID.BASE_NOTIFY_CHARACTERISTIC_UUID,type:"set"===i?r.QingCommandType.SetToken:r.QingCommandType.VerifyToken,data:t});if("errCode"in o)throw this.print("设置 token 失败",o),null==(c=this.onConnectStatusChange)||c.call(this,"set"===i?e.EConnectStep.SetToken:e.EConnectStep.VerifyToken,e.EConnectStepStatus.Failed,this.currentDevice),o;return"success"in o&&(null==(a=this.onConnectStatusChange)||a.call(this,"set"===i?e.EConnectStep.SetToken:e.EConnectStep.VerifyToken,e.EConnectStepStatus.Success,this.currentDevice),o.success)}catch(h){throw null==(o=this.onConnectStatusChange)||o.call(this,"set"===i?e.EConnectStep.SetToken:e.EConnectStep.VerifyToken,e.EConnectStepStatus.Failed,this.currentDevice),this.print("设置 token 失败",h),h}}async write({writeCharacteristicUUID:i,notifyCharacteristicUUID:r="",type:c,data:a,noResponse:o=!1,isSplitReceive:h=!1,timeout:u=this.timeout}){if(!this.isConnected)return Promise.resolve({errCode:e.EErrorCode.Disconnected,errMessage:"蓝牙已断开"});const l=`${r}_${c}`;return this.commandMap.has(l)?Promise.resolve({errCode:e.EErrorCode.InProgress,errMessage:"上一次操作未完成"}):new Promise((async r=>{const C=setTimeout((()=>{this.commandMap.delete(l),r({errCode:e.EErrorCode.Timeout,errMessage:"写入数据超时"})}),u);try{o||this.commandMap.set(l,{type:c,timeoutId:C,isSplitReceive:h,resolve:r,receivedData:new Uint8Array([])});let e=a?new Uint8Array(a):new Uint8Array([]);e=new Uint8Array([e.length+1,c,...e]);let u=Math.ceil(e.length/20);for(let r=0;r<u;r++){const c=20*r,a=20*(r+1),o=e.slice(c,a);this.print(`写入数据[${i}]`,n.uint8Array2hexString(o)),await t.index.writeBLECharacteristicValue({deviceId:this.currentDevice.deviceId,serviceId:s.QingUUID.DEVICE_BASE_SERVICE_UUID,characteristicId:i,value:o.buffer})}o&&(clearTimeout(C),setTimeout((()=>{r({success:!0,data:new Uint8Array})}),100))}catch(d){this.print("写入数据出错：",d),r(d),clearTimeout(C),this.commandMap.delete(l)}}))}async startServiceListen(){var i,n,r;try{null==(i=this.onConnectStatusChange)||i.call(this,e.EConnectStep.Subscribe,e.EConnectStepStatus.InProgress,this.currentDevice);const r=await t.index.getBLEDeviceServices({deviceId:this.currentDevice.deviceId});this.print("服务列表",r);const c=await t.index.getBLEDeviceCharacteristics({deviceId:this.currentDevice.deviceId,serviceId:s.QingUUID.DEVICE_BASE_SERVICE_UUID});this.print("特征值列表",c),c.characteristics.forEach((async e=>{e.properties.notify&&await t.index.notifyBLECharacteristicValueChange({deviceId:this.currentDevice.deviceId,serviceId:s.QingUUID.DEVICE_BASE_SERVICE_UUID,characteristicId:e.uuid,state:!0})})),null==(n=this.onConnectStatusChange)||n.call(this,e.EConnectStep.Subscribe,e.EConnectStepStatus.Success,this.currentDevice)}catch(c){throw null==(r=this.onConnectStatusChange)||r.call(this,e.EConnectStep.Subscribe,e.EConnectStepStatus.Failed,this.currentDevice),this.print("订阅服务失败",c),c}}startScan(){return new Promise((async i=>{var n;null==(n=this.onConnectStatusChange)||n.call(this,e.EConnectStep.Scan,e.EConnectStepStatus.InProgress,this.currentDevice),this.print("开始扫描"),this.scanResolve=i;let s={errCode:e.EErrorCode.NotFound,errMessage:"未找到设备"};this.scanTimer&&(clearTimeout(this.scanTimer),this.scanTimer=null),this.scanTimer=setTimeout((()=>{var t;this.stopScan(),null==(t=this.scanResolve)||t.call(this,s)}),this.timeout),await t.index.openBluetoothAdapter({mode:"central"});const{available:r,discovering:c}=await t.index.getBluetoothAdapterState();if(!r)return s={errCode:e.EErrorCode.NotAvailable,errMessage:"蓝牙不可用"},s;c?this.print("正在扫描中..."):(t.index.onBluetoothDeviceFound(this.onBluetoothDeviceFound),t.index.startBluetoothDevicesDiscovery({allowDuplicatesKey:!0,interval:500,powerLevel:"high"}))}))}filterBroadcast(t){const{name:e,localName:i,serviceData:n,connectable:s}=t;return s&&(e||i)&&n&&(n["0000FDCD-0000-1000-8000-00805F9B34FB"]&&n["0000FDCD-0000-1000-8000-00805F9B34FB"].byteLength>=8||n["0000fdcd-0000-1000-8000-00805f9b34fb"]&&n["0000fdcd-0000-1000-8000-00805f9b34fb"].byteLength>=8)}parseBroadcastData(t){const{serviceData:e,name:i,localName:s,RSSI:r,deviceId:c}=t;let a=e["0000FDCD-0000-1000-8000-00805F9B34FB"];a||(a=e["0000fdcd-0000-1000-8000-00805f9b34fb"]);const o=new Uint8Array(a),h=o[1],u=(128&o[0])>0,l=n.uint8Array2hexString(o),C=n.parseMAC(l.substring(4,16)),d=l.substring(16);let S=100;return d.length>5&&"02"===d.substring(0,2)&&(S=parseInt(d.substring(4,6),16)),{deviceId:c,battery:S,name:i||s,RSSI:r,mac:C,isBind:u,productID:h,broadcastData:l,rawData:t}}setupSubscriptions(){t.index.onBLECharacteristicValueChange(this.onBLECharacteristicValueChange),t.index.onBLEConnectionStateChange(this.onBLEConnectionStateChange)}removeSubscriptions(){t.index.offBLECharacteristicValueChange(),t.index.offBLEConnectionStateChange()}async stopScan(){this.scanTimer&&(clearTimeout(this.scanTimer),this.scanTimer=null),this.print("停止扫描"),await t.index.setKeepScreenOn({keepScreenOn:!1}),await t.index.stopBluetoothDevicesDiscovery(),await t.index.offBluetoothDeviceFound()}async disconnect(){try{this.isConnected&&await t.index.closeBLEConnection({deviceId:this.currentDevice.deviceId})}catch(e){throw this.print("断开连接失败",e),e}finally{this.isConnected=!1,this.currentDevice=null,this.removeSubscriptions()}}release(){this.disconnect()}};c.LogTag="QingBleService";let a=c;exports.QingBleService=a;
